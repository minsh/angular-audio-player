(function(e,t,n){"use strict";t.module("ngAudioPlayer",["ng"]).factory("$player",["$browser","$window","playerConfig",function(e,n,r){var i=function(){var e=document.createElement("audio");return!(e.canPlayType&&e.canPlayType("audio/mpeg;").replace(/no/,""))}(),s=false,o=function(e,n){var r=e.clone(true),i=e.after("<div>");i.next().addClass("angular-player");i.next().attr("className","angular-player");i.next().attr("id","angularPlayer");i.next().append(r);i.next().append(n.markup);i.remove();i=t.element(document.querySelector(N));return i},u=function(e){var n=e.config.flashPlayer,r=n.replace(/\$1/g,"angular-audio-player");r=r.replace(/\$2/g,e.settings.swfLocation);r=r.replace(/\$3/g,+(new Date)+Math.random());e.element.replaceWith(r);e.element=function(){return t.element(document.querySelector("#angular-audio-player"))}()},a=function(){},f=function(e){var t=e.config.createPlayer,n=document.getElementsByClassName(t.errorMessageClass),r='Missing <a href="http://get.adobe.com/flashplayer/">flash player</a> plugin.';if(e.mp3)r+=' <a href="'+e.mp3+'">Download audio file</a>.';e.wrapper.toggleClass(t.errorClass);n.innerHTML=r},l=function(e,n){if(i)return;if(!n.config.createPlayer)return;var r=n.config.createPlayer,s=t.element(document.querySelector(N)),o=t.element(document.querySelector("."+r.playPauseClass)),u=t.element(document.querySelector("."+r.nextInstClass)),a=t.element(document.querySelector("."+r.prevInstClass)),f=t.element(document.querySelector("."+r.scrubberClass)),l=function(e){var t=0;if(e.offsetParent){do{t+=e.offsetLeft}while(e=e.offsetParent)}return t},c=null;o.bind("click",function(e){n.playPause()});u.bind("click",function(e){n.skipTo(c,"n")});a.bind("click",function(e){n.skipTo(c,"p")});h(n)},c=function(e,t){if(t>e.loadedPercent)return;e.element[0].currentTime=e.duration*t;e.updatePlayhead()},h=function(e){if(!e.settings.preload)return;var t,r,e=e,i=/(ipod|iphone|ipad)/i.test(n.navigator.userAgent);t=setInterval(function(){if(e.element[0].readyState>-1){if(!i)e.init(e)}if(e.element[0].readyState>1){if(e.settings.autoplay)e.play(e);clearInterval(t);r=setInterval(function(){e.loadProgress();if(e.loadedPercent>=1)clearInterval(r)})}},10);e.readyTimer=t;e.loadTimer=r},p=function(e,n){var r=e.config.createPlayer,i=t.element(document.querySelector("."+r.progressClass)),s=t.element(document.querySelector("."+r.scrubberClass)),o=t.element(document.querySelector("."+r.playedClass)),u=e.duration*n[0],a=Math.floor(u/60),f=Math.floor(u%60);o.html((a<10?"0":"")+a+":"+(f<10?"0":"")+f);i.css("width",s[0].offsetWidth*n[0]+"px")},d=function(e,t){this.element=e;this.wrapper=e.parent();this.source=e.children("<source>")||e;this.settings=t.settings;this.config=t;this.mp3=function(e){var t=e.children("<source>")[0];return e.attr("src")||(t?t.attr("src"):null)}(e);this.index=0;this.loadStartedCalled=false;this.loadedPercent=0;this.duration=1;this.playing=false;d.prototype.updatePlayhead=function(){var e=this.element[0].currentTime/this.duration;p(this,[e])};d.prototype.skipTo=function(e,t){if(e){e=e}else{var n=this.settings.tags[C],r=this.index,i=n[r]/1e3;if(t==="n"){this.index++}if(t==="p"){this.index--}e=i/this.duration}c(this,e)};d.prototype.load=function(){this.loadStartedCalled=false;this.element[0].load();h(this)};d.prototype.loadError=function(){m(this)};d.prototype.init=function(){y(this)};d.prototype.loadStarted=function(){if(!this.element[0].duration)return false;this.duration=this.element[0].duration;this.updatePlayhead();this.loadStartedCalled=true;b(this)};d.prototype.loadProgress=function(){if(this.element[0].buffered!=null&&this.element[0].buffered.length){if(!this.loadStartedCalled){this.loadStartedCalled=this.loadStarted()}var e=this.element[0].buffered.end(this.element[0].buffered.length-1);this.loadedPercent=e/this.duration;w(this,[this.loadedPercent])}};d.prototype.playPause=function(){if(this.playing)this.pause();else this.play()};d.prototype.play=function(){var e=/(ipod|iphone|ipad)/i.test(n.navigator.userAgent);if(e&&this.element[0].readyState==0)this.init(this);if(!this.settings.preload){this.settings.preload=true;this.element[0].attr("preload","auto");h(this)}this.playing=true;this.element[0].play();x(this)};d.prototype.pause=function(){this.playing=false;this.element[0].pause();S(this)};d.prototype.setVolume=function(e){this.element[0].volume=e};d.prototype.trackEnded=function(e){this.skipTo(this,[0]);if(!this.settings.loop)this.pause(this);_trackEnded(this)}},v=function(e){},m=function(e){},g=function(e,n){var c=r;if(e.attr("autoplay")!=null)c.settings.autoplay=true;if(e.attr("loop")!=null)c.settings.loop=true;if(e.attr("preload")=="none")c.settings.preload=false;if(n){t.forEach(n,function(e,t){c.settings[t]=e})}if(c.createPlayer.markup)e=o(e,c.createPlayer);var h=new d(e,c);if(i&&s){u(h);a(h.wrapper)}else if(i&&!s){f(h)}if(!i||i&&s)l(h.wrapper,h);return h},y=function(e){var t=e.config.createPlayer;e.wrapper.addClass(t.loadingClass)},b=function(e){var n=e.config.createPlayer,r=t.element(document.querySelector("."+n.durationClass)),i=Math.floor(e.duration/60),s=Math.floor(e.duration%60);e.wrapper.removeClass(n.loadingClass);r.html((i<10?"0":"")+i+":"+(s<10?"0":"")+s)},w=function(e,n){var r=e.config.createPlayer,i=t.element(document.querySelector("."+r.scrubberClass)),s=t.element(document.querySelector("."+r.loaderClass));s.css("width",i[0].offsetWidth*n[0]+"px")},E=function(){},S=function(e){var t=e.config.createPlayer;e.wrapper.removeClass(t.playingClass)},x=function(e){var t=e.config.createPlayer;e.wrapper.addClass(t.playingClass)},T=function(e){var n=e.settings.tags[C],r=e.config.createPlayer,i=t.element(document.querySelector("."+r.tagClass));i.children().remove();for(var s=0;s<n.length;s++){var o=n[s]/(e.duration*1e3)*280;console.log(e.duration,o,n[s]/(e.duration*1e3));i.append('<div class="tag" style="left:'+o+'px;"></div>')}},N=null,C=null;if(i){s=function(){if(n.navigator.plugins&&n.navigator.plugins.length&&n.navigator.plugins["Shockwave Flash"]){return true}else if(n.navigator.mimeTypes&&n.navigator.mimeTypes.length){var e=n.navigator.mimeTypes["application/x-shockwave-flash"];return e&&e.enabledPlugin}else{try{var t=new ActiveXObject("ShockwaveFlash.ShockwaveFlash");return true}catch(r){}}return false}()}return{create:function(e,n){var r=document.querySelector(e),i=t.element(r),n=n||null;N=e;return g(i,n)},setTag:function(e,t){C=e;var n=setInterval(function(){if(t.duration>1){T(t);clearInterval(n)}},10)},trackEnd:function(){},setVolume:function(){}}}]).factory("playerConfig",[function(){var e=function(){var e=new RegExp("angular-audio-player(.min)?.js.*"),n=document.querySelectorAll("script"),r=t.element(n);for(var i=0,s=r.length;i<s;i++){var o=r[i].getAttribute("src");if(e.test(o))return o.replace(e,"")}}();return{flashPlayer:'        <object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" id="$1" width="1" height="1" name="$1" style="position: absolute; left: -1px;">           <param name="movie" value="$2?playerInstance=ngplayer.instances[\'$1\']&datetime=$3">           <param name="allowscriptaccess" value="always">           <embed name="$1" src="$2?playerInstance=ngplayer.instances[\'$1\']&datetime=$3" width="1" height="1" allowscriptaccess="always">         </object>',createPlayer:{markup:'          <div class="play-pause">             <p class="play"></p>             <p class="pause"></p>             <p class="loading"></p>             <p class="error"></p>           </div>           <div class="scrubber">             <div class="progress"></div>             <div class="loaded"></div>             <div class="tags"></div>           </div>           <div class="nextBack">             <div class="prevInst"></div>             <div class="nextInst"></div>           </div>           <div class="time">             <em class="played">00:00</em>/<strong class="duration">00:00</strong>           </div>           <div class="error-message"></div>',playPauseClass:"play-pause",nextBackClass:"nextBack",nextInstClass:"nextInst",prevInstClass:"prevInst",scrubberClass:"scrubber",progressClass:"progress",loaderClass:"loaded",timeClass:"time",durationClass:"duration",playedClass:"played",errorMessageClass:"error-message",playingClass:"playing",loadingClass:"loading",tagClass:"tags",errorClass:"error"},settings:{autoplay:false,loop:false,preload:true,imageLocation:e+"player-graphics.gif",swfLocation:e+"angular-audio.swf"}}}])})(window,window.angular)
